```{r}
library(tidyverse)
library(skimr)
library(corrplot)
library(vcd)
```

# Data 

```{r}
data <- read_csv(here::here("data", "data.csv"))
skim(data)
```

## Sources

## Cleaning / transformation

## Missing value analysis

```{r}
# Drop columns that have more than 40% NA values
data <- data[, which(colMeans(!is.na(data)) > 0.40)]
# Dropping "Survey ID" column
data <- data[, -which(names(data) %in% c("Survey ID"))]
```

```{r}
# Checking correlation among columns
unique_df <-  drop_na(data)
```

```{r}
# Finding the number of missing values in each column
data %>% 
  select(everything()) %>% 
  summarise_all(funs(sum(is.na(.))))
```


```{r}
unique_df <- unique_df %>% 
  mutate(
    # Create categories
    Age_Group = dplyr::case_when(
      Age <= 25            ~ "18-25",
      Age > 25 & Age <= 50 ~ "26-50",
      Age > 50 & Age <= 75 ~ "51-75",
      Age > 75             ~ "> 75"
    ),
    # Convert to factor
    Age_Group = factor(
      Age_Group,
      level = c("18-25", "26-50","51-75", "> 75")
    )
  )
```

```{r}
# Finding columns with unique values (0, "text") and replaing "text" with 1
find_and_encode <- function(column) {
  if(is.character(column)) {
    unique_column <- unique(unlist(as.list(column), use.names = FALSE))
    if(length(unique_column) == 2 & sort(unique_column)[1] == "0") {
      column <- replace(column, column != "0", "1")
      class(column) = "numeric"
      return(column)
    }
  }
  return(column)
}

# This data frame consists of columns with unique values (0, "text") encoded as (0, 1)
unique_df_encoded <- apply(unique_df, 2, find_and_encode)

# Converting it from a matrix to a dataframe form
unique_df_encoded <- as.data.frame(unique_df_encoded)

```

```{r}
cols1 <- c("No One", "Spouse", "Children", "Grand Children", "Parent", "Grandparent", "Brother/Sister", "Other Relative", "Friends",
           "Other...17")
cols2 <- c("Full Time Employment", "Part Time Employment", "Self Employed Full Time", "Self Employed Part Time", "Student",                  
           "Homemaker", "Disabled", "Unemployed", "Retired", "Other Employement")

unique_df_encoded[,cols1] <- lapply(unique_df_encoded[,cols1] , as.numeric)

```



```{r}
unique_df_encoded$`Close Blood Relation` <- unique_df_encoded$Spouse + unique_df_encoded$Children + unique_df_encoded$`Grand Children` + 
  unique_df_encoded$Parent+ unique_df_encoded$Grandparent + unique_df_encoded$`Brother/Sister` 

unique_df_encoded$`Others` <- unique_df_encoded$`Other Relative`+ unique_df_encoded$`Friends`+ unique_df_encoded$`Other...17`


plot1 <- pivot_longer(unique_df_encoded, cols = c("Close Blood Relation", "Others", "No One"), names_to = "living_with" , values_to = "no_of_people")

```


```{r}
plot1 <- subset(plot1, no_of_people != 0 )


counts1 <- plot1[c("living_with", "Age_Group", "Present Mental Health")] %>% group_by(living_with, Age_Group, `Present Mental Health`) %>% 
  summarise(Freq = n()) %>% 
  ungroup() %>% 
  complete(Age_Group, living_with, `Present Mental Health`, fill = list(Freq = 0))

names(counts1) <- c("Age_Group", "living_with", "PresentMentalHealth", "Freq")

counts1$Age_Group = factor(counts1$Age_Group, levels = c("18-25", "26-50", "51-75", "> 75"))
mosaic(PresentMentalHealth ~ Age_Group + living_with , data = counts1, direction = c("v", "v", "h"), spacing = spacing_highlighting())




```


